---
import TechChip from "@/components/TechChip.astro";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import Header from "../../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import { PATHS } from "../../paths";
import {combineDates } from "../../utils";

// worksコレクションから全データを取得し、開始日の降順でソート
const works = (await getCollection("works")).sort(
  (a, b) => {
    // 比較用の年を取得（aboutYear > startDateの年 > 0）
    const aYear = a.data.aboutYear
      ?? (a.data.startDate ? a.data.startDate.getFullYear() : 0);
    const bYear = b.data.aboutYear
      ?? (b.data.startDate ? b.data.startDate.getFullYear() : 0);

    if (bYear !== aYear) {
      return bYear - aYear;
    }
    // 年が同じ場合、startDateがあれば月まで考慮
    if (a.data.startDate && b.data.startDate) {
      return b.data.startDate.valueOf() - a.data.startDate.valueOf();
    }
    return 0;
  },
);
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <BaseHead
      title={`Works - ${SITE_TITLE}`}
      description={SITE_DESCRIPTION}
      noIndex={true}
    />
  </head>
  <body>
    <Header />
    <main class="w-[800px] mx-auto px-4">
      <h1>Works</h1>
      <section class="space-y-8">
        {
          works.map((work) => {
            const { data } = work;
            const { startDate, endDate, aboutYear } = data;
            return (
            <article class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
              <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-semibold mt-0 mb-4">
                  <a href={PATHS.works.work(work.id)}>
                    {work.data.title}
                  </a>
                </h2>
                <time class="text-sm text-gray-500 whitespace-nowrap ml-4">
                  {combineDates({startDate, endDate, aboutYear})}
                </time>
              </div>

              {
                work.data.description && (
                  <p class="text-gray-700 mb-4">{work.data.description}</p>
                )
              }

              {
                work.data.techs && work.data.techs.length > 0
                  && (
                  <div class="flex flex-wrap gap-2">
                    {work.data.techs.map((tech) => <TechChip tech={tech} />)}
                  </div>
                )
              }
            </article>
          );
          })
        }
      </section>
    </main>
    <Footer />
  </body>
</html>
